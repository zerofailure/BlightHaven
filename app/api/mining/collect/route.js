import { auth } from '@clerk/nextjs'; import { connectDB } from '@/lib/db'; import OreSession from '@/models/OreSession'; import { getOreById } from '@/lib/miningLogic'; import UserInventory from '@/models/UserInventory'; import { addItemToInventory } from '@/lib/inventoryHelpers'; export async function POST() { const { userId } = auth(); await connectDB(); const session = await OreSession.findOne({ userId }); if (!session) return Response.json({ collected: 0 }); const ore = getOreById(session.oreId); const seconds = Math.floor((Date.now() - new Date(session.startTime)) / ore.interval); const collected = seconds; const xp = collected * ore.xpPerSecond; let player = await UserInventory.findOne({ userId }); if (!player) player = new UserInventory({ userId, inventory: [] }); player.inventory = addItemToInventory(player.inventory, ore.id, collected); await player.save(); await OreSession.deleteOne({ userId }); return Response.json({ collected, xp, oreId: ore.id }); }